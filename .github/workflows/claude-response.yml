name: Claude Issue Response

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  claude-response:
    if: contains(github.event.issue.body, '@claude') || contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install @anthropic-ai/sdk
        
    - name: Process Claude Request
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_BODY: ${{ github.event.issue.body || github.event.comment.body }}
      run: |
        cat > claude_processor.js << 'EOF'
        const Anthropic = require('@anthropic-ai/sdk');
        const fs = require('fs');
        
        const anthropic = new Anthropic({
          apiKey: process.env.ANTHROPIC_API_KEY,
        });
        
        async function processRequest() {
          try {
            const issueBody = process.env.ISSUE_BODY;
            const issueTitle = process.env.ISSUE_TITLE;
            const issueNumber = process.env.ISSUE_NUMBER;
            
            // Read the current code files
            const mainPy = fs.readFileSync('main.py', 'utf8');
            const readme = fs.readFileSync('README.md', 'utf8');
            
            const prompt = `You are Claude, an AI assistant helping with code optimization. A user has created a GitHub issue requesting help.
            
        Issue Title: ${issueTitle}
        Issue Description: ${issueBody}
        
        Current main.py content:
        \`\`\`python
        ${mainPy}
        \`\`\`
        
        Please analyze the request and provide a helpful response. If they're asking for code optimization, suggest specific improvements. If they want you to make changes, provide the optimized code.
        
        Keep your response concise and actionable. Format code suggestions in proper markdown code blocks.`;
        
            const message = await anthropic.messages.create({
              model: "claude-3-5-sonnet-20241022",
              max_tokens: 2000,
              messages: [{
                role: "user",
                content: prompt
              }]
            });
            
            console.log("CLAUDE_RESPONSE:" + message.content[0].text);
          } catch (error) {
            console.error('Error calling Claude API:', error);
            console.log("CLAUDE_RESPONSE:Sorry, I encountered an error processing your request. Please make sure the ANTHROPIC_API_KEY secret is properly configured in the repository settings.");
          }
        }
        
        processRequest();
        EOF
        
        node claude_processor.js
        
    - name: Post Claude Response
      uses: actions/github-script@v7
      env:
        CLAUDE_RESPONSE: ${{ env.CLAUDE_RESPONSE }}
      with:
        script: |
          const { execSync } = require('child_process');
          
          // Get Claude's response from the previous step
          const output = execSync('node claude_processor.js', { encoding: 'utf8' });
          const claudeResponse = output.split('CLAUDE_RESPONSE:')[1]?.trim();
          
          if (claudeResponse) {
            const comment = `ðŸ¤– **Claude Response:**
        
        ${claudeResponse}
        
        ---
        *This response was generated automatically by Claude via GitHub Actions.*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "âŒ Failed to get response from Claude. Please check the ANTHROPIC_API_KEY secret configuration."
            });
          }